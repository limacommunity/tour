<!DOCTYPE html>
<html>
<head>
<title>Lima Community Church Virtual Tour</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui" />
<style> @-ms-viewport { width: device-width; } </style>
<link rel="stylesheet" href="vendor/reset.min.css">
<link rel="stylesheet" href="style.css">
  <style>
    * { margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; font-family: Arial, sans-serif; }
    #pano { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    
    .music-controls {
      position: absolute;
      top: 0px;
      right: 90px;
      display: flex;
      gap: 10px;
      z-index: 1000;
    }
    
    .music-button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(67, 67, 67, 0.8);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      padding: 0;
    }
    
    .music-button:hover {
      background: rgba(100, 100, 100, 0.9);
    }
    
    .music-button svg {
      fill: white;
      width: 20px;
      height: 20px;
    }
    
    .volume-slider-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .volume-slider {
      position: absolute;
	  top: 0px;
      right: 100px;
      width: 0;
      height: 40px;
      background: rgba(67, 67, 67, 0.8);
      border-radius: 20px;
      overflow: hidden;
      opacity: 0;
      transition: width 0.3s, opacity 0.3s;
      display: flex;
      align-items: center;
      padding: 0;
    }
    
    .volume-slider.active {
      width: 120px;
      opacity: 1;
      padding: 0 15px;
    }
    
    .volume-slider input[type="range"] {
      width: 100%;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(255, 255, 255, 0.3);
      outline: none;
      border-radius: 2px;
    }
    
    .volume-slider input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
    }
    
    .volume-slider input[type="range"]::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      border: none;
    }
    
    .scene-nav {
      position: absolute;
      bottom: 30px;
      left: 30px;
      width: 280px;
      z-index: 1000;
      max-height: calc(100vh - 60px);
      overflow-y: auto;
    }
    
    .scene-nav::-webkit-scrollbar {
      width: 6px;
    }
    
    .scene-nav::-webkit-scrollbar-track {
      background: rgba(67, 67, 67, 0.3);
      border-radius: 0px;
    }
    
    .scene-nav::-webkit-scrollbar-thumb {
      background: rgba(100, 100, 100, 0.6);
      border-radius: 0px;
    }
    
    .ungrouped-scenes {
      margin-bottom: 10px;
    }
    
    .group {
      margin-bottom: 10px;
      background: rgba(67, 67, 67, 0.3);
      border-radius: 0px;
      overflow: hidden;
    }
    
    .group-header {
      padding: 12px 15px;
      background: rgba(67, 67, 67, 0.3);
      color: white;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      font-weight: bold;
      transition: background 0.2s;
      -webkit-user-select: none;
	  user-select: none; 
    }
    
    .group-header:hover {
      background: rgba(80, 80, 80, 0.9);
    }
    
    .group-header .arrow {
      transition: transform 0.3s;
      font-size: 12px;
    }
    
    .group-header.collapsed .arrow {
      transform: rotate(-90deg);
    }
    
    .group-content {
      max-height: 500px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .group-content.collapsed {
      max-height: 0;
    }
    
    .scene-button {
      width: 100%;
      padding: 10px 15px;
      background: rgba(50, 50, 50, 0.3);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .ungrouped-scenes .scene-button {
      background: rgba(67, 67, 67, 0.3);
      border-radius: 0px;
      margin-bottom: 10px;
      border-bottom: none;
    }
    
    .ungrouped-scenes .scene-button:hover {
      background: rgba(80, 80, 80, 0.9);
    }
    
    .group .scene-button:last-child {
      border-bottom: none;
    }
    
    .scene-button:hover {
      background: rgba(70, 70, 70, 0.8);
    }
    
    .scene-button.active {
      background: rgba(33, 150, 243, 0.9);
    }
	 .scene-nav {
      position: absolute;
      top: 40px;
      left: 0px;
      width: 250px;
      z-index: 1000;
      max-height: calc(100vh - 60px);
      overflow-y: auto;
    }
    
    .scene-nav::-webkit-scrollbar {
      width: 6px;
    }
    
    .scene-nav::-webkit-scrollbar-track {
      background: rgba(67, 67, 67, 0.3);
      border-radius: 0px;
    }
    
    .scene-nav::-webkit-scrollbar-thumb {
      background: rgba(100, 100, 100, 0.6);
      border-radius: 0px;
    }
    
    .ungrouped-scenes {
      margin-bottom: 10px;
    }
    
    .group {
      margin-bottom: 0px;
      background: rgba(67, 67, 67, 0.3);
      border-radius: 0px;
      overflow: hidden;
    }
    
    .group-header {
      padding: 12px 15px;
      background: rgba(67, 67, 67, 0.3);
      color: white;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      font-weight: bold;
      transition: background 0.2s;
	  -webkit-user-select: none;
      user-select: none;
    }
    
    .group-header:hover {
      background: rgba(80, 80, 80, 0.3);
    }
    
    .group-header .arrow {
      transition: transform 0.3s;
      font-size: 12px;
    }
    
    .group-header.collapsed .arrow {
      transform: rotate(-90deg);
    }
    
    .group-content {
      max-height: 400px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .group-content.collapsed {
      max-height: 0;
    }
    
    .scene-button {
      width: 100%;
      padding: 10px 15px;
      background: rgba(50, 50, 50, 0.6);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .ungrouped-scenes .scene-button {
      background: rgba(67, 67, 67, 0.8);
      border-radius: 0px;
      margin-bottom: 0px;
      border-bottom: none;
    }
    
    .ungrouped-scenes .scene-button:hover {
      background: rgba(80, 80, 80, 0.9);
    }
    
    .group .scene-button:last-child {
      border-bottom: none;
    }
    
    .scene-button:hover {
      background: rgba(70, 70, 70, 0.8);
    }
    
    .scene-button.active {
      background: rgba(33, 150, 243, 0.9);
    }
	
	.link-button {
      width: 100%;
      padding: 10px 15px;
      background: rgba(67, 67, 67, 0.8);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
      text-align: left;
      margin-bottom: 0px;
      border-radius: 0px;
      text-decoration: none;
      display: block;
    }
    
    .link-button:hover {
      background: rgba(100, 150, 100, 0.9);
    }
	
	 /* Hotspot styles */
    .hotspot {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(33, 150, 243, 0.9);
      border: 3px solid white;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .hotspot:hover {
      transform: scale(1.2);
      background: rgba(33, 150, 243, 1);
    }
    
    .hotspot.link-hotspot {
      background: rgba(76, 175, 80, 0.9);
    }
    
    .hotspot.link-hotspot:hover {
      background: rgba(76, 175, 80, 1);
    }
    
    .hotspot-icon {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      font-weight: bold;
    }
    
    .info-popup {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      max-width: 300px;
      pointer-events: none;
      z-index: 2000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    
    .info-popup-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 8px;
    }
    
    .info-popup-text {
      font-size: 14px;
      line-height: 1.4;
    }
	
  </style>
</head>
<body class="multiple-scenes view-control-buttons">

<div id="pano"></div>

<!-- <div class="music-controls">
    <button class="music-button" id="playPauseBtn" title="Play/Pause Music">
      <svg id="playIcon" viewBox="0 0 24 24">
        <path d="M8 5v14l11-7z"/>
      </svg>
      <svg id="pauseIcon" viewBox="0 0 24 24" style="display:none;">
        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
      </svg>
    </button>
    
    <div class="volume-slider-container">
      <button class="music-button" id="volumeBtn" title="Volume">
        <svg id="volumeIcon" viewBox="0 0 24 24">
          <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
        </svg>
      </button>
      <div class="volume-slider" id="volumeSlider">
        <input type="range" id="volumeRange" min="0" max="100" value="70">
      </div>
    </div>
</div>


-->
<div id="titleBar">
  <h1 class="sceneName"></h1>
</div>

<div class="music-controls">
    <button class="music-button" id="playPauseBtn" title="Play/Pause Music">
      <svg id="playIcon" viewBox="0 0 24 24">
        <path d="M8 5v14l11-7z"/>
      </svg>
      <svg id="pauseIcon" viewBox="0 0 24 24" style="display:none;">
        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
      </svg>
    </button>
    
    <div class="volume-slider-container">
      <button class="music-button" id="volumeBtn" title="Volume">
        <svg id="volumeIcon" viewBox="0 0 24 24">
          <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
        </svg>
      </button>
      <div class="volume-slider" id="volumeSlider">
        <input type="range" id="volumeRange" min="0" max="100" value="50">
      </div>
    </div>
</div>


<a href="javascript:void(0)" id="autorotateToggle">
  <img class="icon off" src="img/play.png">
  <img class="icon on" src="img/pause.png">
</a>

<a href="javascript:void(0)" id="fullscreenToggle">
  <img class="icon off" src="img/fullscreen.png">
  <img class="icon on" src="img/windowed.png">
</a>

<a href="javascript:void(0)" id="sceneListToggle">
  <img class="icon off" src="img/expand.png">
  <img class="icon on" src="img/collapse.png">
</a>

<a href="javascript:void(0)" id="viewUp" class="viewControlButton viewControlButton-1">
  <img class="icon" src="img/up.png">
</a>
<a href="javascript:void(0)" id="viewDown" class="viewControlButton viewControlButton-2">
  <img class="icon" src="img/down.png">
</a>
<a href="javascript:void(0)" id="viewLeft" class="viewControlButton viewControlButton-3">
  <img class="icon" src="img/left.png">
</a>
<a href="javascript:void(0)" id="viewRight" class="viewControlButton viewControlButton-4">
  <img class="icon" src="img/right.png">
</a>
<a href="javascript:void(0)" id="viewIn" class="viewControlButton viewControlButton-5">
  <img class="icon" src="img/plus.png">
</a>
<a href="javascript:void(0)" id="viewOut" class="viewControlButton viewControlButton-6">
  <img class="icon" src="img/minus.png">
</a>

<div class="scene-nav" id="sceneNav"></div>

<script src="vendor/screenfull.min.js" ></script>
<script src="vendor/bowser.min.js" ></script>
<script src="vendor/marzipano.js" ></script>

<script src="data.js"></script>
<!-- <script src="index.js"></script> -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/marzipano/0.10.2/marzipano.js"></script> -->
<script>  

    // Setup
  var sceneNameElement = document.querySelector('#titleBar .sceneName');
  var sceneListElement = document.querySelector('#sceneNav');
  var sceneElements = document.querySelectorAll('#sceneList .scene');  
  var sceneListToggleElement = document.querySelector('#sceneListToggle');
  var autorotateToggleElement = document.querySelector('#autorotateToggle');
  var fullscreenToggleElement = document.querySelector('#fullscreenToggle');
	
  // Detect desktop or mobile mode.
  if (window.matchMedia) {
    var setMode = function() {
      if (mql.matches) {
        document.body.classList.remove('desktop');
        document.body.classList.add('mobile');
      } else {
        document.body.classList.remove('mobile');
        document.body.classList.add('desktop');
      }
    };
    var mql = matchMedia("(max-width: 500px), (max-height: 500px)");
    setMode();
    mql.addListener(setMode);
  } else {
    document.body.classList.add('desktop');
  }

  // Detect whether we are on a touch device.
  document.body.classList.add('no-touch');
  window.addEventListener('touchstart', function() {
    document.body.classList.remove('no-touch');
    document.body.classList.add('touch');
  });

  // Use tooltip fallback mode on IE < 11.
  if (bowser.msie && parseFloat(bowser.version) < 11) {
    document.body.classList.add('tooltip-fallback');
  }

  // Viewer options.
  var viewerOpts = {
    controls: {
      mouseViewMode: projectData.settings.mouseViewMode
    }
  };


	
	// Flatten scenes for easy access
    const allScenes = [];
    
    projectData.menu.forEach(item => {
      if (item.type === 'scene') {
        allScenes.push(item);
      } else if (item.type === 'group') {
        item.scenes.forEach(scene => {
          allScenes.push(scene);
        });
      }
    });
	
	// const defaultMusic = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3'); 
	const defaultMusic = new Audio('assets/Stream-Music-Christmas-2023.mp3');
    defaultMusic.loop = true;
    defaultMusic.volume = 0.5;
    
    let sceneMusic = null;
    let isPlaying = false;
    let savedDefaultTime = 0;
    let currentSceneIndex = 0;
     
    // Play/Pause functionality
    const playPauseBtn = document.getElementById('playPauseBtn');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    
    playPauseBtn.addEventListener('click', () => {
      if (isPlaying) {
        pauseMusic();
      } else {
        playMusic();
      }
    });
    
    function playMusic() {
      if (sceneMusic) {
        sceneMusic.play();
      } else {
        defaultMusic.play();
      }
      isPlaying = true;
      playIcon.style.display = 'none';
      pauseIcon.style.display = 'block';
    }
    
    function pauseMusic() {
      if (sceneMusic) {
        sceneMusic.pause();
      } else {
        defaultMusic.pause();
      }
      isPlaying = false;
      playIcon.style.display = 'block';
      pauseIcon.style.display = 'none';
    }
    
    // Volume control
    const volumeBtn = document.getElementById('volumeBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeRange = document.getElementById('volumeRange');
    
    volumeBtn.addEventListener('click', () => {
      volumeSlider.classList.toggle('active');
    });
    
    volumeRange.addEventListener('input', (e) => {
      const volume = e.target.value / 100;
      defaultMusic.volume = volume;
      if (sceneMusic) sceneMusic.volume = volume;
    });
    
    // Close volume slider when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.volume-slider-container')) {
        volumeSlider.classList.remove('active');
      }
    });
    
    // Scene music management
    function switchToSceneMusic(sceneIndex) {
      const scene = allScenes[sceneIndex];
      
      // If scene has custom music
      if (scene.music) {
        // Save default music position and pause
        savedDefaultTime = defaultMusic.currentTime;
        defaultMusic.pause();
        
        // Create and play scene music
        if (sceneMusic) {
          sceneMusic.pause();
          sceneMusic = null;
        }
        
        sceneMusic = new Audio(scene.music);
        sceneMusic.volume = volumeRange.value / 100;
        
        sceneMusic.addEventListener('ended', () => {
          // Return to default music when scene music ends
          sceneMusic = null;
          defaultMusic.currentTime = savedDefaultTime;
          if (isPlaying) defaultMusic.play();
        });
        
        if (isPlaying) sceneMusic.play();
      } else {
        // No custom music for this scene, use default
        if (sceneMusic) {
          sceneMusic.pause();
          sceneMusic = null;
        }
        
        defaultMusic.currentTime = savedDefaultTime;
        if (isPlaying) defaultMusic.play();
      }
    }
    
    // Marzipano setup
    const panoElement = document.getElementById('pano');
//    const viewer = new Marzipano.Viewer(panoElement);
    
	/*
    // Create scenes with placeholder images
    const scenes = [
      { name: 'Scene 1', levels: createLevels(2000) },
      { name: 'Scene 2', levels: createLevels(2000) },
      { name: 'Scene 3', levels: createLevels(2000) }
    ];
	
	*/
    
    /* function createLevels(size) {
      return [{
        tileSize: 256,
        size: size,
        fallbackOnly: true
      }];
    }
	*/
    
    /* const scenesData = scenes.map((scene, index) => {
      const geometry = new Marzipano.CubeGeometry(scene.levels);
      
      const source = new Marzipano.ImageUrlSource((tile) => {
        const colors = ['4A90E2', 'E24A4A', '4AE290'];
        return `https://via.placeholder.com/256/${colors[index]}/ffffff?text=${scene.name}`;
      });
      
      const view = new Marzipano.RectilinearView();
      
      return viewer.createScene({
        source: source,
        geometry: geometry,
        view: view,
        pinFirstLevel: true
      });
    });
    
    // Switch to first scene
    scenesData[0].switchTo();
    
    // Scene navigation
    const sceneButtons = document.querySelectorAll('.scene-button');
    sceneButtons.forEach((button, index) => {
      button.addEventListener('click', () => {
        scenesData[index].switchTo();
        switchToSceneMusic(index);
        
        sceneButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
      });
    });
    
	*/
	
		
	// Create scenes from project data
    function createLevels(size) {
      return [{
        tileSize: 256,
        size: size,
        fallbackOnly: true
      }];
    }
	
	function findSceneById(id) {
      for (var i = 0; i < allScenes.length; i++) {
        if (allScenes[i].data.id === id) {
          return allScenes[i];
        }
      }
      return null;
    }
	
	function findSceneDataById(id) {
      for (var i = 0; i < allScenes.scenes.length; i++) {
        if (allScenes.scenes[i].id === id) {
          return allScenes.scenes[i];
        }
      }
      return null;
    }
    
	/*
    const scenesData = allScenes.map((scene, index) => {
      /*const geometry = new Marzipano.CubeGeometry(createLevels(scene.size));
      
      const source = new Marzipano.ImageUrlSource((tile) => {
        return `https://via.placeholder.com/256/${scene.color}/ffffff?text=${scene.name}`;
      });
      
      const view = new Marzipano.RectilinearView();
      
	   
      return viewer.createScene({
        source: source,
        geometry: geometry,
        view: view,
        pinFirstLevel: true
      });
    });
    
	*/
 // Viewer options.
  var viewerOpts = {
    controls: {
      mouseViewMode: projectData.settings.mouseViewMode
    }
  };	
	// Initialize viewer.
  var viewer = new Marzipano.Viewer(panoElement, viewerOpts);

  // Create scenes.
  const scenesData = allScenes.map((scene, index) => {
    var urlPrefix = "tiles";
    var source = Marzipano.ImageUrlSource.fromString(
      urlPrefix + "/" + scene.id + "/{z}/{f}/{y}/{x}.jpg",
      { cubeMapPreviewUrl: urlPrefix + "/" + scene.id + "/preview.jpg" });
    var geometry = new Marzipano.CubeGeometry(scene.levels);

    var limiter = Marzipano.RectilinearView.limit.traditional(scene.faceSize, 100*Math.PI/180, 120*Math.PI/180);
    var view = new Marzipano.RectilinearView(scene.initialViewParameters, limiter);

	  const marzipanoScene = viewer.createScene({
        source: source,
        geometry: geometry,
        view: view,
        pinFirstLevel: true
      });
      
	  
	  // Add link hotspots if defined
      if (scene.linkHotspots) {
        scene.linkHotspots.forEach(hotspot => {
            const hotspotElement = createHotspot(hotspot, index);
			marzipanoScene.hotspotContainer().createHotspot(hotspotElement, {
                yaw: hotspot.yaw,
                pitch: hotspot.pitch
		    });
		});
      };	
	  
      // Add scene info hotspot if info is defined
      if (scene.info) {
        const infoHotspot = {
          id: scene.id + '-info',
          type: 'info',
          yaw: scene.info.yaw || 0,
          pitch: scene.info.pitch || 0.5,
          title: scene.info.title || scene.name,
          text: scene.info.text
        };
        
        const infoElement = createHotspot(infoHotspot, index);
        marzipanoScene.hotspotContainer().createHotspot(infoElement, {
          yaw: infoHotspot.yaw,
          pitch: infoHotspot.pitch
        });
      }
      
      // Add additional hotspots if defined
      if (scene.hotspots) {
        scene.hotspots.forEach(hotspot => {
          const hotspotElement = createHotspot(hotspot, index);
          marzipanoScene.hotspotContainer().createHotspot(hotspotElement, {
            yaw: hotspot.yaw,
            pitch: hotspot.pitch
		  });
        });
      }
      
      return marzipanoScene;
    });
	
	// Create hotspot elements
    function createHotspot(hotspot, sceneIndex) {
      const wrapper = document.createElement('div');
      wrapper.className = 'hotspot' + (hotspot.type === 'link' ? ' link-hotspot' : '');
      wrapper.dataset.hotspotId = hotspot.id;
      
      const icon = document.createElement('img');
	  icon.src = 'img/link.png';
      icon.className = 'hotspot-icon';
      icon.textContent = hotspot.type === 'info' ? 'i' : '→';
      wrapper.appendChild(icon);
	 
    // Create image element.
    //var icon = document.createElement('img');
    //icon.src = 'img/link.png';
    //icon.classList.add('hotspot-icon');

	 
	     // Set rotation transform.
    var transformProperties = [ '-ms-transform', '-webkit-transform', 'transform' ];
    for (var i = 0; i < transformProperties.length; i++) {
      var property = transformProperties[i];
      icon.style[property] = 'rotate(' + hotspot.rotation + 'rad)';
    }
      
      if (hotspot.type === 'info') {
        // Info hotspot - show popup on hover
        let popup = null;
        
        wrapper.addEventListener('mouseenter', (e) => {
          popup = document.createElement('div');
          popup.className = 'info-popup';
          
          if (hotspot.title) {
            const title = document.createElement('div');
            title.className = 'info-popup-title';
            title.textContent = hotspot.title;
            popup.appendChild(title);
          }
          
          if (hotspot.text) {
            const text = document.createElement('div');
            text.className = 'info-popup-text';
            text.textContent = hotspot.text;
            popup.appendChild(text);
          }
          
          document.body.appendChild(popup);
          
          // Position popup near hotspot
          const rect = wrapper.getBoundingClientRect();
          popup.style.left = (rect.left + rect.width / 2 - popup.offsetWidth / 2) + 'px';
          popup.style.top = (rect.top - popup.offsetHeight - 10) + 'px';
        });
        
        wrapper.addEventListener('mouseleave', () => {
          if (popup && popup.parentNode) {
            popup.parentNode.removeChild(popup);
            popup = null;
          }
        });
        
      } else if (hotspot.type === 'link') {
        // Link hotspot - navigate to another scene
        wrapper.style.cursor = 'pointer';
        
        // Show target scene name on hover
        if (hotspot.text) {
          wrapper.title = hotspot.text;
        }
        
        wrapper.addEventListener('click', () => {
          // Find target scene index
          const targetIndex = allScenes.findIndex(s => s.id === hotspot.target);
          if (targetIndex !== -1) {
            scenesData[targetIndex].switchTo();
            switchToSceneMusic(targetIndex);
            currentSceneIndex = targetIndex;
            
            // Update active button in menu
            document.querySelectorAll('.scene-button').forEach(btn => {
              btn.classList.remove('active');
              if (parseInt(btn.dataset.sceneIndex) === targetIndex) {
                btn.classList.add('active');
              }
            });
          }
        });
      }
      
      return wrapper;
    }
	
	
	
	// Switch to first scene
    scenesData[0].switchTo();
	
    // Build accordion menu
    const sceneNav = document.getElementById('sceneNav');
    let sceneIndexCounter = 0;
    
    projectData.menu.forEach((item) => {
      if (item.type === 'scene') {
        // Create standalone scene button
        const globalSceneIndex = sceneIndexCounter++;
        const button = document.createElement('button');
        button.className = 'scene-button';
        button.style.marginBottom = '0px';
        button.style.borderRadius = '0px';
        button.style.background = 'rgba(67, 67, 67, 0.8)';
        button.style.borderBottom = 'none';
        button.textContent = item.name;
        button.dataset.sceneIndex = globalSceneIndex;
        button.dataset.sceneId = item.id;
        
        if (globalSceneIndex === 0) {
          button.classList.add('active');
        }
        
        button.addEventListener('click', () => {
          scenesData[globalSceneIndex].switchTo();
          switchToSceneMusic(globalSceneIndex);
          currentSceneIndex = globalSceneIndex;
          
          document.querySelectorAll('.scene-button').forEach(btn => {
            btn.classList.remove('active');
          });
          button.classList.add('active');
        });
        
        button.addEventListener('mouseenter', () => {
          button.style.background = 'rgba(80, 80, 80, 0.9)';
        });
        
        button.addEventListener('mouseleave', () => {
          if (!button.classList.contains('active')) {
            button.style.background = 'rgba(67, 67, 67, 0.8)';
          }
        });
        
        sceneNav.appendChild(button);
		
	  } else if (item.type === 'link') {
        // Create external link button
        const link = document.createElement('a');
        link.className = 'link-button';
        link.href = item.url;
        link.textContent = item.name;
        link.dataset.linkId = item.id;
        
        if (item.newTab !== false) {
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
        }
        
        sceneNav.appendChild(link);
        
      } else if (item.type === 'group') {
        // Create accordion group
        const groupDiv = document.createElement('div');
        groupDiv.className = 'group';
        groupDiv.dataset.groupId = item.id;
        
        const groupHeader = document.createElement('div');
        groupHeader.className = 'group-header' + (item.collapsed ? ' collapsed' : '');
        groupHeader.innerHTML = `
          <span>${item.name}</span>
          <span class="arrow">▼</span>
        `;
        
        const groupContent = document.createElement('div');
        groupContent.className = 'group-content' + (item.collapsed ? ' collapsed' : '');
        
        item.scenes.forEach((scene) => {
          const globalSceneIndex = sceneIndexCounter++;
          const button = document.createElement('button');
          button.className = 'scene-button';
          button.textContent = '  ' + scene.name;
          button.dataset.sceneIndex = globalSceneIndex;
          button.dataset.sceneId = scene.id;
          
          if (sceneIndexCounter === 1) {
            button.classList.add('active');
          }
          
          button.addEventListener('click', () => {
            scenesData[globalSceneIndex].switchTo();
            switchToSceneMusic(globalSceneIndex);
            currentSceneIndex = globalSceneIndex;
            
            document.querySelectorAll('.scene-button').forEach(btn => {
              btn.classList.remove('active');
            });
            button.classList.add('active');
          });
          
          groupContent.appendChild(button);
        });
        
        groupHeader.addEventListener('click', () => {
          groupHeader.classList.toggle('collapsed');
          groupContent.classList.toggle('collapsed');
        });
        
        groupDiv.appendChild(groupHeader);
        groupDiv.appendChild(groupContent);
        sceneNav.appendChild(groupDiv);
      }
    });
    
	// Switch to first scene
    scenesData[0].switchTo();
	
	// Set up autorotate, if enabled.
  var autorotate = Marzipano.autorotate({
    yawSpeed: 0.03,
    targetPitch: 0,
    targetFov: Math.PI/2
  });
  if (projectData.settings.autorotateEnabled) {
    autorotateToggleElement.classList.add('enabled');
  }

  // Set handler for autorotate toggle.
  autorotateToggleElement.addEventListener('click', toggleAutorotate);

  // Set up fullscreen mode, if supported.
  if (screenfull.enabled && projectData.settings.fullscreenButton) {
    document.body.classList.add('fullscreen-enabled');
    fullscreenToggleElement.addEventListener('click', function() {
      screenfull.toggle();
    });
    screenfull.on('change', function() {
      if (screenfull.isFullscreen) {
        fullscreenToggleElement.classList.add('enabled');
      } else {
        fullscreenToggleElement.classList.remove('enabled');
      }
    });
  } else {
    document.body.classList.add('fullscreen-disabled');
  }
  
  // Set handler for scene list toggle.
  sceneListToggleElement.addEventListener('click', toggleSceneList);

  // Start with the scene list open on desktop.
  if (!document.body.classList.contains('mobile')) {
    showSceneList();
  }

  function showSceneList() {
    sceneListElement.classList.add('enabled');
    sceneListToggleElement.classList.add('enabled');
  }

  function hideSceneList() {
    sceneListElement.classList.remove('enabled');
    sceneListToggleElement.classList.remove('enabled');
  }

  function toggleSceneList() {
    sceneListElement.classList.toggle('enabled');
    sceneListToggleElement.classList.toggle('enabled');
  }

  function startAutorotate() {
    if (!autorotateToggleElement.classList.contains('enabled')) {
      return;
    }
    viewer.startMovement(autorotate);
    viewer.setIdleMovement(3000, autorotate);
  }

  function stopAutorotate() {
    viewer.stopMovement();
    viewer.setIdleMovement(Infinity);
  }

  function toggleAutorotate() {
    if (autorotateToggleElement.classList.contains('enabled')) {
      autorotateToggleElement.classList.remove('enabled');
      stopAutorotate();
    } else {
      autorotateToggleElement.classList.add('enabled');
      startAutorotate();
    }
  }
  
  function createLinkHotspotElement(hotspot) {

    // Create wrapper element to hold icon and tooltip.
    var wrapper = document.createElement('div');
    wrapper.classList.add('hotspot');
    wrapper.classList.add('link-hotspot');

    // Create image element.
    var icon = document.createElement('img');
    icon.src = 'img/link.png';
    icon.classList.add('link-hotspot-icon');

    // Set rotation transform.
    var transformProperties = [ '-ms-transform', '-webkit-transform', 'transform' ];
    for (var i = 0; i < transformProperties.length; i++) {
      var property = transformProperties[i];
      icon.style[property] = 'rotate(' + hotspot.rotation + 'rad)';
    }

    // Add click event handler.
    wrapper.addEventListener('click', function() {
      switchScene(findSceneById(hotspot.target));
    });

    // Prevent touch and scroll events from reaching the parent element.
    // This prevents the view control logic from interfering with the hotspot.
    stopTouchAndScrollEventPropagation(wrapper);

    // Create tooltip element.
    var tooltip = document.createElement('div');
    tooltip.classList.add('hotspot-tooltip');
    tooltip.classList.add('link-hotspot-tooltip');
    tooltip.innerHTML = findSceneDataById(hotspot.target).name;

    wrapper.appendChild(icon);
    wrapper.appendChild(tooltip);

    return wrapper;
  }

  function createInfoHotspotElement(hotspot) {

    // Create wrapper element to hold icon and tooltip.
    var wrapper = document.createElement('div');
    wrapper.classList.add('hotspot');
    wrapper.classList.add('info-hotspot');

    // Create hotspot/tooltip header.
    var header = document.createElement('div');
    header.classList.add('info-hotspot-header');

    // Create image element.
    var iconWrapper = document.createElement('div');
    iconWrapper.classList.add('info-hotspot-icon-wrapper');
    var icon = document.createElement('img');
    icon.src = 'img/info.png';
    icon.classList.add('info-hotspot-icon');
    iconWrapper.appendChild(icon);

    // Create title element.
    var titleWrapper = document.createElement('div');
    titleWrapper.classList.add('info-hotspot-title-wrapper');
    var title = document.createElement('div');
    title.classList.add('info-hotspot-title');
    title.innerHTML = hotspot.title;
    titleWrapper.appendChild(title);

    // Create close element.
    var closeWrapper = document.createElement('div');
    closeWrapper.classList.add('info-hotspot-close-wrapper');
    var closeIcon = document.createElement('img');
    closeIcon.src = 'img/close.png';
    closeIcon.classList.add('info-hotspot-close-icon');
    closeWrapper.appendChild(closeIcon);

    // Construct header element.
    header.appendChild(iconWrapper);
    header.appendChild(titleWrapper);
    header.appendChild(closeWrapper);

    // Create text element.
    var text = document.createElement('div');
    text.classList.add('info-hotspot-text');
    text.innerHTML = hotspot.text;

    // Place header and text into wrapper element.
    wrapper.appendChild(header);
    wrapper.appendChild(text);

    // Create a modal for the hotspot content to appear on mobile mode.
    var modal = document.createElement('div');
    modal.innerHTML = wrapper.innerHTML;
    modal.classList.add('info-hotspot-modal');
    document.body.appendChild(modal);

    var toggle = function() {
      wrapper.classList.toggle('visible');
      modal.classList.toggle('visible');
    };

    // Show content when hotspot is clicked.
    wrapper.querySelector('.info-hotspot-header').addEventListener('click', toggle);

    // Hide content when close icon is clicked.
    modal.querySelector('.info-hotspot-close-wrapper').addEventListener('click', toggle);

    // Prevent touch and scroll events from reaching the parent element.
    // This prevents the view control logic from interfering with the hotspot.
    stopTouchAndScrollEventPropagation(wrapper);

    return wrapper;
  }

  // Prevent touch and scroll events from reaching the parent element.
  function stopTouchAndScrollEventPropagation(element, eventList) {
    var eventList = [ 'touchstart', 'touchmove', 'touchend', 'touchcancel',
                      'wheel', 'mousewheel' ];
    for (var i = 0; i < eventList.length; i++) {
      element.addEventListener(eventList[i], function(event) {
        event.stopPropagation();
      });
    }
  }
  
   // DOM elements for view controls.
  var viewUpElement = document.querySelector('#viewUp');
  var viewDownElement = document.querySelector('#viewDown');
  var viewLeftElement = document.querySelector('#viewLeft');
  var viewRightElement = document.querySelector('#viewRight');
  var viewInElement = document.querySelector('#viewIn');
  var viewOutElement = document.querySelector('#viewOut');

  // Dynamic parameters for controls.
  var velocity = 0.7;
  var friction = 3;

  // Associate view controls with elements.
  var controls = viewer.controls();
  controls.registerMethod('upElement',    new Marzipano.ElementPressControlMethod(viewUpElement,     'y', -velocity, friction), true);
  controls.registerMethod('downElement',  new Marzipano.ElementPressControlMethod(viewDownElement,   'y',  velocity, friction), true);
  controls.registerMethod('leftElement',  new Marzipano.ElementPressControlMethod(viewLeftElement,   'x', -velocity, friction), true);
  controls.registerMethod('rightElement', new Marzipano.ElementPressControlMethod(viewRightElement,  'x',  velocity, friction), true);
  controls.registerMethod('inElement',    new Marzipano.ElementPressControlMethod(viewInElement,  'zoom', -velocity, friction), true);
  controls.registerMethod('outElement',   new Marzipano.ElementPressControlMethod(viewOutElement, 'zoom',  velocity, friction), true);

  function sanitize(s) {
    return s.replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;');
  }

  function switchScene(scene) {
    stopAutorotate();
//    scene.view.setParameters(scene.initialViewParameters);
//    scene.scene.switchTo();
    startAutorotate();
    updateSceneName(scene);
 //   updateSceneList(scene);
  }

  function updateSceneName(scene) {
    sceneNameElement.innerHTML = sanitize(scene.name);
  }
  
  

  //Start Autorotate
  startAutorotate();
	
  // Auto-play music on first user interaction
    document.addEventListener('click', () => {
      if (!isPlaying) {
        playMusic();
      }
    }, { once: true });
	
  // Display the initial scene.
  switchScene(allScenes[0]);
	
  </script>
</body>
</html>
